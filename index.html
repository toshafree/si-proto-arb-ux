<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ê—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π —Å–∫—Ä–∏–Ω–µ—Ä ‚Äî –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–≤—è–∑–æ–∫</title>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- lightweight-charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
    }
    body { display: flex; }

    #app {
      display: flex;
      flex: 1;
      height: 100vh;
      overflow: hidden;
    }

    /* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å */
    .sidebar {
      background: #020617;
      border-right: 1px solid #1e293b;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 220px;
      max-width: 380px;
      width: 260px;
      resize: horizontal;
      overflow: auto;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }
    .sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: #cbd5f5;
    }

    .btn {
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      background: #1d4ed8;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .btn:disabled { opacity: 0.35; cursor: default; }
    .btn-secondary { background: #1e293b; }
    .btn-danger { background: #b91c1c; }

    .pairs-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }
    .pair-item {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      background: rgba(15, 23, 42, 0.9);
    }
    .pair-item:hover { border-color: #334155; }
    .pair-item.active {
      border-color: #3b82f6;
      background: rgba(15, 23, 42, 0.95);
    }
    .pair-name {
      font-size: 13px;
      font-weight: 500;
      color: #e5e7eb;
    }
    .pair-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
    }

    .badge {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }
    .badge-status-online {
      background: rgba(22, 163, 74, 0.15);
      color: #4ade80;
    }
    .badge-status-offline {
      background: rgba(148, 163, 184, 0.15);
      color: #e5e7eb;
    }
    .badge-status-error {
      background: rgba(239, 68, 68, 0.15);
      color: #fb7185;
    }
    .badge-edit-published {
      background: rgba(56, 189, 248, 0.15);
      color: #7dd3fc;
    }
    .badge-edit-draft {
      background: rgba(234, 179, 8, 0.15);
      color: #facc15;
    }
    .badge-edit-preview {
      background: rgba(129, 140, 248, 0.15);
      color: #a5b4fc;
    }

    /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .header {
      padding: 10px 14px;
      border-bottom: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #020617;
    }
    .header-top {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
    }
    .title-input {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020618;
      color: #e5e7eb;
    }
    .title-input:disabled { opacity: 0.7; }

    .header-mode {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      white-space: nowrap;
    }

    .header-status-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: #9ca3af;
      min-height: 18px;
    }

    .pill-label { font-weight: 500; }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-panel {
      border-bottom: 1px solid #1f2937;
      padding: 8px 12px;
      background: #020617;
      min-height: 160px;
      max-height: 60%;
      resize: vertical;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .editor-edit-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      flex-wrap: wrap;
    }
    .editor-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .editor-label-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    textarea.formula-editor {
      width: 100%;
      min-height: 80px;
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020618;
      color: #e5e7eb;
      padding: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      resize: vertical;
    }
    textarea.formula-editor:disabled { opacity: 0.6; }
    .editor-hint {
      font-size: 11px;
      color: #9ca3af;
    }

    .chart-panel {
      flex: 1;
      position: relative;
      background: #020617;
    }
    #chart {
      position: absolute;
      inset: 0;
    }
    .chart-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #9ca3af;
      pointer-events: none;
    }
    .chart-top-label {
      position: absolute;
      top: 6px;
      right: 10px;
      font-size: 11px;
      color: #9ca3af;
      background: rgba(15, 23, 42, 0.8);
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid #1f2937;
    }
    .chart-symbol-label {
      position: absolute;
      top: 6px;
      left: 10px;
      font-size: 11px;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.9);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
    }
    .chart-loading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #9ca3af;
      background: rgba(15, 23, 42, 0.5);
      pointer-events: none;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">–°–≤—è–∑–∫–∏</div>
      <button class="btn btn-secondary" @click="addPair">
        + –ù–æ–≤–∞—è
      </button>
    </div>

    <div class="pairs-list">
      <div
        v-for="pair in pairs"
        :key="pair.id"
        class="pair-item"
        :class="{ active: pair.id === selectedPairId }"
        @click="selectPair(pair.id)"
      >
        <div class="pair-name">{{ pair.title }}</div>
        <div class="pair-meta">
          <span>–ì—Ä–∞—Ñ–∏–∫: {{ pair.symbol || '‚Äî' }}</span>
          <span
            class="badge"
            :class="{
              'badge-status-online': pair.status === '–û–Ω–ª–∞–π–Ω',
              'badge-status-offline': pair.status === '–û—Ç–∫–ª—é—á–µ–Ω–∞',
              'badge-status-error': pair.status === '–û—à–∏–±–∫–∞'
            }"
          >
            {{ pair.status }}
          </span>
        </div>
      </div>
    </div>
  </aside>

  <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
  <main class="main" v-if="selectedPair">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <header class="header">
      <div class="header-top">
        <input
          class="title-input"
          v-model="selectedPair.title"
        />

        <!-- –†–µ–∂–∏–º —Å–≤—è–∑–∫–∏ —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É -->
        <div class="header-mode">
          <span class="pill-label">–†–µ–∂–∏–º —Å–≤—è–∑–∫–∏:</span>
          <span
            class="badge"
            :class="{
              'badge-status-online': selectedPair.status === '–û–Ω–ª–∞–π–Ω',
              'badge-status-offline': selectedPair.status === '–û—Ç–∫–ª—é—á–µ–Ω–∞',
              'badge-status-error': selectedPair.status === '–û—à–∏–±–∫–∞'
            }"
          >
            {{ selectedPair.status }}
          </span>

          <!-- –ó–∞–ø—É—Å–∫ —Å–≤—è–∑–∫–∏ -->
          <button
            v-if="['–û—Ç–∫–ª—é—á–µ–Ω–∞', '–û—à–∏–±–∫–∞'].includes(selectedPair.status)"
            class="btn btn-secondary"
            @click="startPair"
          >
            ‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å
          </button>
        </div>
      </div>

      <div class="header-status-row">
        <div v-if="editingStatus !== '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞'">
          <span v-if="hasUnappliedChanges">
            –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –≥—Ä–∞—Ñ–∏–∫—É
          </span>
          <span v-else>
            –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
          </span>
        </div>
      </div>
    </header>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: —Ä–µ–¥–∞–∫—Ç–æ—Ä + –≥—Ä–∞—Ñ–∏–∫ -->
    <section class="content">
      <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Ñ–æ—Ä–º—É–ª—ã -->
      <div class="editor-panel">
        <!-- –°—Ç–∞—Ç—É—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è + –∫–Ω–æ–ø–∫–∏ –Ω–∞–¥ —Ñ–æ—Ä–º—É–ª–æ–π -->
        <div class="editor-edit-row">
          <span class="pill-label">–§–æ—Ä–º—É–ª–∞:</span>
          <span
            class="badge"
            :class="{
              'badge-edit-published': editingStatus === '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞',
              'badge-edit-draft': editingStatus === '–ß–µ—Ä–Ω–æ–≤–∏–∫',
              'badge-edit-preview': editingStatus === '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä'
            }"
          >
            {{ editingStatus }}
          </span>

          <div class="editor-buttons">
            <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
            <button
              v-if="editingStatus === '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞'"
              class="btn btn-secondary"
              @click="startEditing"
            >
              ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>

            <button
              v-if="editingStatus !== '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞'"
              class="btn btn-secondary"
              :disabled="!hasUnappliedChanges"
              @click="applyPreview"
            >
              üëÅ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
            </button>

            <button
              v-if="editingStatus !== '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞'"
              class="btn btn-secondary"
              @click="discardDraft"
            >
              ‚Ü© –û—Ç–º–µ–Ω–∏—Ç—å
            </button>

            <button
              v-if="editingStatus === '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä'"
              class="btn"
              @click="publishDraft"
            >
              ‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
            </button>
          </div>
        </div>

        <div class="editor-label-row">
          <span>–§–æ—Ä–º—É–ª–∞ —Å–≤—è–∑–∫–∏</span>
          <span v-if="editingStatus === '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞'">
            –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.
          </span>
        </div>
        <textarea
          class="formula-editor"
          v-model="draftFormula"
          :disabled="editingStatus === '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞'"
        ></textarea>
        <!-- –≤–∞–∂–Ω–æ: v-pre, —á—Ç–æ–±—ã Vue –Ω–µ –ø–∞—Ä—Å–∏–ª {{CRZ5}} -->
        <div class="editor-hint" v-pre>
          –ü—Ä–∏–º–µ—Ä –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤: <code>{{CRZ5}}</code>, <code>{{CNYRUBF}}</code>.
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫ -->
      <div class="chart-panel">
        <div id="chart"></div>
        <div class="chart-symbol-label" v-if="chartSymbolToShow">
          {{ chartSymbolToShow }} (15m, Binance Futures)
        </div>
        <div class="chart-top-label">
          –ì—Ä–∞—Ñ–∏–∫:
          <span v-if="editingStatus === '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞'">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞</span>
          <span v-else-if="editingStatus === '–ß–µ—Ä–Ω–æ–≤–∏–∫'">LIVE (–ø–æ—Å–ª–µ–¥–Ω—è—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è)</span>
          <span v-else>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
        </div>
        <div class="chart-overlay" v-if="!chartSymbolToShow && !isChartLoading">
          –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤—è–∑–∫—É –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.
        </div>
        <div class="chart-loading" v-if="isChartLoading">
          –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫ {{ chartSymbolToShow }}...
        </div>
      </div>
    </section>
  </main>

  <!-- –ï—Å–ª–∏ —Å–≤—è–∑–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ -->
  <main class="main" v-else>
    <header class="header">
      <div class="header-top">
        <div class="sidebar-title">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–≤—è–∑–∫–∏</div>
      </div>
      <div class="header-status-row">
        –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤—è–∑–∫—É —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é.
      </div>
    </header>
    <section class="content">
      <div class="chart-panel">
        <div class="chart-overlay">
          –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–≤—è–∑–∫–∏.
        </div>
      </div>
    </section>
  </main>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      pairs: [
        {
          id: 1,
          title: 'CRZ5 / CNYRUBF',
          status: '–û—Ç–∫–ª—é—á–µ–Ω–∞',
          formula: 'let spread = {{CRZ5}}/{{CNYRUBF}}',
          symbol: 'BTCUSDT'
        },
        {
          id: 2,
          title: 'EDZ5 / EUZ5 / SIZ5',
          status: '–û–Ω–ª–∞–π–Ω',
          formula: 'let spread = {{EDZ5}} / ({{EUZ5}} * {{SIZ5}})',
          symbol: 'ETHUSDT'
        },
        {
          id: 3,
          title: 'FX_EURUSD / CME_6EZ5',
          status: '–û–Ω–ª–∞–π–Ω',
          formula: 'let spread = {{FX_EURUSD}}/ {{CME_6EZ5}}',
          symbol: 'XRPUSDT'
        },
        {
          id: 4,
          title: 'GLDRUBF - CME_GCZ5',
          status: '–û—à–∏–±–∫–∞',
          formula: 'let spread = {{GLDRUBF}} - {{CME_GCZ5}}',
          symbol: 'ONDOUSDT'
        }
      ],
      randomTickers: [
        'AWEUSDT',
        'AXLUSDT',
        'AXSUSDT',
        'B2USDT',
        'B3USDT',
        'BABYUSDT',
        'BANANAS31USDT',
        'BANANAUSDT',
        'BANDUSDT',
        'BANKUSDT',
        'BANUSDT',
        'BARDUSDT',
        'BASUSDT',
        'BATUSDT',
        'BBUSDT',
        'BCHUSDC',
        'BCHUSDT',
        'BDXNUSDT'
      ],
      selectedPairId: 1,
      editingStatus: '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞', // –ß–µ—Ä–Ω–æ–≤–∏–∫ / –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä / –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞
      draftFormula: '',
      lastPreviewFormula: null,
      previewSymbol: null,
      chart: null,
      series: null,
      isChartLoading: false
    };
  },
  computed: {
    selectedPair() {
      return this.pairs.find(p => p.id === this.selectedPairId) || null;
    },
    hasUnappliedChanges() {
      if (this.editingStatus === '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞') return false;
      return this.draftFormula !== this.lastPreviewFormula;
    },
    chartSymbolToShow() {
      if (!this.selectedPair) return null;
      if (this.editingStatus === '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä' && this.previewSymbol) {
        return this.previewSymbol;
      }
      return this.selectedPair.symbol || null;
    }
  },
  methods: {
    initChart() {
      const container = document.getElementById('chart');
      if (!container) return;

      if (
        typeof window.LightweightCharts === 'undefined' ||
        typeof window.LightweightCharts.createChart !== 'function'
      ) {
        console.error('LightweightCharts –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è –∏–ª–∏ –Ω–µ—Ç createChart');
        return;
      }

      this.chart = window.LightweightCharts.createChart(container, {
        layout: {
          background: { color: '#020617' },
          textColor: '#e5e7eb'
        },
        rightPriceScale: {
          borderColor: '#1f2937'
        },
        timeScale: {
          borderColor: '#1f2937'
        },
        grid: {
          vertLines: { color: '#111827' },
          horzLines: { color: '#111827' }
        },
        crosshair: {
          mode: window.LightweightCharts.CrosshairMode.Normal
        }
      });

      if (!this.chart || typeof this.chart.addLineSeries !== 'function') {
        console.error('chart.addLineSeries –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å –≤–µ—Ä—Å–∏—é lightweight-charts');
        return;
      }

      this.series = this.chart.addLineSeries();
    },
    async loadChartData(symbol) {
      if (!this.chart || !this.series || !symbol) return;
      this.isChartLoading = true;
      try {
        const url = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=200`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        const mapped = data.map(k => ({
          time: Math.floor(k[0] / 1000),
          value: parseFloat(k[4])
        }));
        this.series.setData(mapped);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞', e);
      } finally {
        this.isChartLoading = false;
      }
    },
    selectPair(id) {
      this.selectedPairId = id;
      if (this.selectedPair) {
        this.editingStatus = '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞';
        this.draftFormula = this.selectedPair.formula;
        this.lastPreviewFormula = this.selectedPair.formula;
        this.previewSymbol = null;
      }
      // –≥—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ watcher chartSymbolToShow
    },
    addPair() {
      const newId = this.pairs.length
        ? Math.max(...this.pairs.map(p => p.id)) + 1
        : 1;
      const newPair = {
        id: newId,
        title: '–ù–æ–≤–∞—è —Å–≤—è–∑–∫–∞ ' + newId,
        status: '–û—Ç–∫–ª—é—á–µ–Ω–∞',
        formula: '',
        symbol: ''
      };
      this.pairs.push(newPair);
      this.selectedPairId = newId;
      // —Å—Ä–∞–∑—É —Ä–µ–∂–∏–º –ß–µ—Ä–Ω–æ–≤–∏–∫ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è —Ñ–æ—Ä–º—É–ª–∞
      this.editingStatus = '–ß–µ—Ä–Ω–æ–≤–∏–∫';
      this.draftFormula = '';
      this.lastPreviewFormula = null;
      this.previewSymbol = null;
    },
    startEditing() {
      if (!this.selectedPair) return;
      this.editingStatus = '–ß–µ—Ä–Ω–æ–≤–∏–∫';
      this.draftFormula = this.selectedPair.formula;
      this.lastPreviewFormula = this.selectedPair.formula;
      this.previewSymbol = null;
    },
    applyPreview() {
      if (!this.selectedPair) return;
      if (!this.hasUnappliedChanges) return;

      const idx = Math.floor(Math.random() * this.randomTickers.length);
      this.previewSymbol = this.randomTickers[idx];
      this.lastPreviewFormula = this.draftFormula;
      this.editingStatus = '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä';
      // –≥—Ä–∞—Ñ–∏–∫ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ watcher
    },
    discardDraft() {
      if (!this.selectedPair) return;
      this.editingStatus = '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞';
      this.draftFormula = this.selectedPair.formula;
      this.lastPreviewFormula = this.selectedPair.formula;
      this.previewSymbol = null;
    },
    publishDraft() {
      if (!this.selectedPair) return;

      if (this.selectedPair.status === '–û–Ω–ª–∞–π–Ω') {
        const ok = window.confirm(
          '–°–≤—è–∑–∫–∞ —Å–µ–π—á–∞—Å –≤ –æ–Ω–ª–∞–π–Ω–µ. –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ñ–æ—Ä–º—É–ª–∞ –∏ —Å–∏–º–≤–æ–ª –≥—Ä–∞—Ñ–∏–∫–∞ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?'
        );
        if (!ok) return;
      }

      this.selectedPair.formula = this.draftFormula;
      if (this.previewSymbol) {
        this.selectedPair.symbol = this.previewSymbol;
      }
      this.editingStatus = '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞';
      this.lastPreviewFormula = this.draftFormula;
      this.previewSymbol = null;
    },
    startPair() {
      if (!this.selectedPair) return;
      this.selectedPair.status = '–û–Ω–ª–∞–π–Ω';
    }
  },
  mounted() {
    this.initChart();
    if (this.selectedPair) {
      this.draftFormula = this.selectedPair.formula;
      this.lastPreviewFormula = this.selectedPair.formula;
    }
    if (this.chartSymbolToShow) {
      this.loadChartData(this.chartSymbolToShow);
    }
  },
  watch: {
    chartSymbolToShow(newSymbol, oldSymbol) {
      if (newSymbol && newSymbol !== oldSymbol) {
        this.loadChartData(newSymbol);
      }
    },
    draftFormula(newVal, oldVal) {
      if (
        this.editingStatus === '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä' &&
        newVal !== this.lastPreviewFormula
      ) {
        this.editingStatus = '–ß–µ—Ä–Ω–æ–≤–∏–∫';
      }
    }
  }
}).mount('#app');
</script>
</body>
</html>
